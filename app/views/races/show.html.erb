<% content_for :head do %>
 <script type="text/javascript">
 var pusher = new Pusher('<%= Pusher.key %>')
 var card_channel = pusher.subscribe('<%="card#{@race.card.id}"%>');
 card_channel.bind('<%="card#{@race.card.id}"%>', function(data) {
   alert(data.greeting);
 });
 </script>
<%end%>
<h1> <%= @track.track_alias%>: <%= link_to @track.name, track_path(@track.id)%></h1>
<div class='box2'>
<h2>  <%= @track.meet_alias%>: <%= link_to @meet.name, @meet %>--<%=@meet.status%></h2>
<%= render :partial => 'meets/credits' %>
</div>
<div class='box2'>
<h3> <%= @track.card_alias%>: <%= link_to @race.card.name, card_path(:id => @race.card.id) %>--<%=@card.status%></h3>
<%= render :partial => 'cards/credits' %>
</div>
<div class='box2'>
<h4><%= @track.race_alias%>: <%=@race.name%>--<%=@race.status%></h4>

Total Pool: <%= @race.total_bets%>
 <p> <%= @race.description %></p>
<p>
  <b>Start time:</b>
  <%= @race.start_betting_time.strftime("%B %d at %I:%M %p %Z") %>
---
  <b>End time:</b>
  <%= @race.post_time.strftime("%B %d at %I:%M %p %Z") %>
</p>
<%if user_is_track_owner?(@track) %>
    <%if @race.status == 'Open' %>
      <%= link_to "Close #{@track.race_alias}", close_race_path(:id => @race.id, :status => 'Close'), :class => 'btn btn-mini btn-warning' %>
    <%else%>
      <%= link_to "Open #{@track.race_alias}", close_race_path(:id => @race.id, :status => 'Open'), :class => 'btn btn-mini btn-warning' %>
      <%= link_to "Payout #{@track.race_alias}", payout_race_path(:id => @race.id), :class => 'btn btn-mini btn-warning', data: { confirm: 'Are you sure? This will payout this race.' } %>
    <%end%>
   <%= link_to "Delete #{@track.race_alias}", @race, method: :delete, data: { confirm: 'Are you sure? This will delete this race.' }, :class => 'btn btn-mini btn-danger' %>
<td><%= link_to "Edit #{@track.race_alias}", edit_race_path(@race), :class => 'btn btn-mini btn-warning' %> 
<%end%>

<table class='table table-striped table-bordered table-condensed'>

<% @horses.each do |horse| %>
  <tr>
    <td><%= horse.name %></td>
    <td><%= horse.description %></td>
    <td><%= horse.finish %></td>
    <td>Total Bets: <%= horse.total_bets %> Odds: <%=horse.odds%></td>

<%if @race.betting_status == 'Open' %>
  <%if horse.status == 'Open'%>
    <% if user_signed_in? %>
      <td><%= link_to 'Bet', new_bet_path(:horse_id => horse.id), :class => 'btn btn-success' %></td>
    <%else%>
      <td><%= link_to 'Login to Bet', new_user_session_path , :class => 'btn btn-mini btn-info' %> </td>
    <%end%>

  <%elsif horse.status == 'Scratched' %>
       <td>Scratched</td>
  <%else%>
     <td><%= horse.status %></td>   

   <%end%>
<%else%>
    <td><%=@betting_status%></td>
<%end%>
<%if user_is_track_owner?(@track) %>
    <td><%= link_to "Edit #{@track.horse_alias}", edit_horse_path(horse, :race_id => @race.id), :class => 'btn btn-mini btn-warning' %> <%= link_to "Delete #{@track.horse_alias}", horse, method: :delete, data: { confirm: 'Are you sure?' }, :class => 'btn btn-mini btn-danger' %></td>
   
<%end%>
  </tr>
<% end %>
</table>

<br />
<%if user_is_track_owner?(@track) %>
<%= link_to "New #{@track.horse_alias}", new_horse_path(:race_id => @race.id), :class => 'btn btn-mini btn-warning' %>


<%end%>
</div>
<div class='box2'>
<% if user_signed_in? %>
<%= link_to 'New Comment', new_comment_path(:race_id => @race.id), :class => 'btn' %>
<%else%>
Log in to Comment
<%end%>
  <%= render :partial => 'comments/index_table' %>


</div>
